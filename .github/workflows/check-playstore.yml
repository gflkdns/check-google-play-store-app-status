name: Check app status

on: workflow_dispatch

env:
  PACKAGES: "com.cacostar.evilprank com.example.app2 com.example.app3"

jobs:
  check_app_status:
    runs-on: ubuntu-latest
    steps:
    
    - name: check node version
      run: node --version
    
    - name: Install google-play-scraper
      run: |
            sudo apt-get update
            sudo apt-get install -y nodejs npm
            sudo npm install -g npm@9.6.6
            sudo npm install -g google-play-scraper
    - name: Check google-play-scraper installation
      run: |
          which google-play-scraper || (sudo apt-get update && sudo apt-get install -y nodejs npm && sudo npm install -g google-play-scraper)
      
    - name: Check google-play-scraper command in PATH
      run: |
          echo $PATH | grep -q "$(npm prefix -g)/bin" && echo "google-play-scraper is in PATH" || (echo "google-play-scraper is not in PATH" && echo 'export PATH="$HOME/.npm-global/bin:$PATH"' >> ~/.bashrc && source ~/.bashrc)
    - name: Check google-play-scraper command path
      run: |
          echo $PATH | tr : '\n' | grep "$(npm prefix -g)/bin"
    
    - name: Load package names
      run: echo "PACKAGES=\"$PACKAGES\"" >> $GITHUB_ENV

    - name: Check google-play-scraper command
      run: google-play-scraper --version

    - name: Check app status
      run: |
        for package in $PACKAGES; do
          status=$(google-play-scraper $package | jq -r '.[0].status')
          if [[ "$status" != "SUCCESS" ]]; then
            echo "Error: $package is not published. Status: $status"
          else
            echo "Package: $package"
            echo "Status: $status"
          fi
        done
